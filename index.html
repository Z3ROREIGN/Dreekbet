<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>DreekBet - Painel</title>
<style>
  body {
    background: #2c2f33;
    color: #fff;
    font-family: Arial, sans-serif;
    margin: 0; padding: 0;
    display: flex;
    justify-content: center;
    align-items: center;
    min-height: 100vh;
  }
  .container {
    background: #23272a;
    padding: 20px;
    border-radius: 8px;
    width: 400px;
    text-align: center;
  }
  button {
    background: #7289da;
    border: none;
    padding: 10px 20px;
    color: white;
    cursor: pointer;
    border-radius: 6px;
    margin: 5px 0;
  }
  button:hover {
    background: #5b6eae;
  }
  #messages {
    height: 150px;
    background: #99aab5;
    color: #000;
    overflow-y: auto;
    padding: 10px;
    border-radius: 6px;
    text-align: left;
    margin-bottom: 10px;
  }
  input[type="text"] {
    width: 70%;
    padding: 8px;
    border-radius: 6px;
    border: none;
  }
</style>
</head>
<body>

<div class="container" id="content">
  <h1>DreekBet</h1>
  <button id="loginBtn">Entrar com Discord</button>
</div>

<script>
const clientId = '1391419432257060914'; // Seu client ID já inserido
const redirectUri = 'https://dreekbet.shop';
const scope = 'identify guilds';
const backendUrl = '/api';

const params = new URLSearchParams(window.location.search);
const code = params.get('code');

const content = document.getElementById('content');
const loginBtn = document.getElementById('loginBtn');

if (!code) {
  loginBtn.onclick = () => {
    const oauthUrl = `https://discord.com/api/oauth2/authorize?client_id=${clientId}&redirect_uri=${encodeURIComponent(redirectUri)}&response_type=code&scope=${encodeURIComponent(scope)}`;
    window.location.href = oauthUrl;
  };
} else {
  content.innerHTML = '<p>Carregando...</p>';
  fetch(`${backendUrl}/auth`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ code })
  })
    .then(res => res.json())
    .then(data => {
      if (data.error) {
        content.innerHTML = `<p>Erro: ${data.error}</p>`;
        return;
      }
      showDashboard(data.user, data.isAdmin);
      window.history.replaceState({}, document.title, '/');
    })
    .catch(() => content.innerHTML = '<p>Erro no servidor</p>');
}

function showDashboard(user, isAdmin) {
  content.innerHTML = `
    <h2>Bem-vindo, ${user.username}#${user.discriminator}</h2>
    <img src="https://cdn.discordapp.com/avatars/${user.id}/${user.avatar}.png" style="border-radius:50%" width="100" />
    <p>ID: ${user.id}</p>
    <button onclick="logout()">Sair</button>
    <div>
      <h3>Seu Bot</h3>
      <button onclick="hostBot()">Hospedar Bot</button>
      <button onclick="stopBot()">Parar Bot</button>
      <button onclick="removeBot()">Remover Bot</button>
    </div>
    <div>
      <h3>Suporte</h3>
      <div id="messages"></div>
      <input type="text" id="msgInput" placeholder="Digite sua mensagem" />
      <button onclick="sendMsg()">Enviar</button>
    </div>
    ${isAdmin ? `
      <div>
        <h3>Painel Admin</h3>
        <p>Aqui você pode aprovar pagamentos e hospedagens (em breve)</p>
      </div>
    ` : ''}
  `;

  loadMessages(user.id);
}

function logout() {
  window.location.href = '/';
}

async function hostBot() {
  const userId = await getUserId();
  const botData = prompt('Cole o código/fonte do seu bot em Python (simulado):');
  if (!botData) return alert('Você precisa enviar o código do bot.');

  const res = await fetch(`${backendUrl}/bots`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ userId, botData })
  });
  const data = await res.json();
  if (data.error) return alert('Erro: ' + data.error);
  alert(data.message);
}

async function stopBot() {
  alert('Função parar bot ainda não implementada.');
}

async function removeBot() {
  const userId = await getUserId();
  const res = await fetch(`${backendUrl}/bots?userId=${userId}`, { method: 'DELETE' });
  const data = await res.json();
  if (data.error) return alert('Erro: ' + data.error);
  alert(data.message);
}

async function getUserId() {
  return document.querySelector('p').textContent.replace('ID: ', '').trim();
}

async function loadMessages(userId) {
  const messagesEl = document.getElementById('messages');
  messagesEl.innerHTML = '<p>Carregando mensagens...</p>';

  const res = await fetch(`${backendUrl}/support?userId=${userId}`);
  const data = await res.json();

  if (data.messages.length === 0) {
    messagesEl.innerHTML = '<p>Sem mensagens ainda.</p>';
    return;
  }

  messagesEl.innerHTML = data.messages
    .map(m => `<p><strong>${m.author === 'user' ? 'Você' : 'Admin'}:</strong> ${m.text}</p>`)
    .join('');
  messagesEl.scrollTop = messagesEl.scrollHeight;
}

async function sendMsg() {
  const input = document.getElementById('msgInput');
  const text = input.value.trim();
  if (!text) return alert('Digite uma mensagem.');

  const userId = await getUserId();
  await fetch(`${backendUrl}/support`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ userId, message: text })
  });

  input.value = '';
  await loadMessages(userId);
}
</script>

</body>
</html>
