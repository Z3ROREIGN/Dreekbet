<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>DreekBet - Painel</title>
<style>
  body {
    margin: 0;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: #2c2f33;
    color: #fff;
    display: flex;
    justify-content: center;
    align-items: flex-start;
    min-height: 100vh;
    padding: 20px;
  }
  .container {
    background: #23272a;
    border-radius: 8px;
    padding: 25px;
    box-shadow: 0 0 15px #000;
    max-width: 700px;
    width: 100%;
  }
  .avatar {
    border-radius: 50%;
    box-shadow: 0 0 10px #000;
    width: 96px;
    height: 96px;
  }
  h2 {
    margin: 10px 0 5px;
    color: #7289da;
  }
  p {
    margin: 0;
    color: #b9bbbe;
    font-size: 14px;
  }
  .btn {
    margin-top: 15px;
    padding: 10px 20px;
    background: #7289da;
    border: none;
    border-radius: 6px;
    color: white;
    cursor: pointer;
    font-weight: 600;
    transition: background-color 0.3s ease;
  }
  .btn:hover:not(:disabled) {
    background: #5b6eae;
  }
  .btn:disabled {
    background: #99aab5;
    cursor: not-allowed;
  }
  #botsList {
    margin-top: 20px;
  }
  .bot-card {
    background: #2c2f33;
    border-radius: 6px;
    padding: 15px;
    margin-bottom: 12px;
    box-shadow: 0 0 5px #000;
  }
  .bot-card strong {
    font-size: 16px;
    color: #fff;
  }
  .bot-actions button {
    margin-right: 10px;
    padding: 6px 12px;
    border: none;
    border-radius: 5px;
    background: #7289da;
    color: white;
    cursor: pointer;
    font-weight: 600;
    transition: background-color 0.3s ease;
  }
  .bot-actions button:hover {
    background: #5b6eae;
  }
  #supportChat {
    margin-top: 25px;
    background: #2c2f33;
    padding: 15px;
    border-radius: 6px;
    max-height: 300px;
    overflow-y: auto;
  }
  #supportChat div {
    margin-bottom: 10px;
  }
  #supportInput {
    width: calc(100% - 110px);
    padding: 8px;
    border-radius: 4px;
    border: none;
    margin-right: 8px;
  }
  #sendMsgBtn {
    padding: 8px 15px;
    border: none;
    border-radius: 4px;
    background: #7289da;
    color: white;
    cursor: pointer;
  }
</style>
</head>
<body>
<div class="container" id="content">
  <p>Carregando...</p>
</div>

<script>
  const CLIENT_ID = "SEU_CLIENT_ID_DISCORD_AQUI"; // Troque pelo seu client ID
  const REDIRECT_URI = window.location.origin;    // Ex: https://dreekbet.shop
  const OAUTH2_URL = `https://discord.com/api/oauth2/authorize?client_id=${CLIENT_ID}&redirect_uri=${encodeURIComponent(REDIRECT_URI)}&response_type=code&scope=identify`;

  const BACKEND_URL = window.location.origin;

  // Redireciona para o OAuth2 direto no Discord se não tiver o code
  function redirectToDiscord() {
    window.location.href = OAUTH2_URL;
  }

  // Troca o code por info do usuário
  async function getUserInfo(code) {
    const res = await fetch(`${BACKEND_URL}/auth`, {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({ code }),
    });
    if (!res.ok) throw new Error('Falha ao obter dados do usuário');
    return await res.json();
  }

  // Pega bots do usuário
  async function getBots(userId) {
    const res = await fetch(`${BACKEND_URL}/bots/${userId}`);
    if (!res.ok) throw new Error('Falha ao carregar bots');
    return await res.json();
  }

  // Iniciar bot via backend
  async function startBot(botId) {
    const res = await fetch(`${BACKEND_URL}/bots/${botId}/start`, { method: 'POST' });
    if (res.ok) alert('Bot iniciado!');
    else alert('Erro ao iniciar bot');
    loadBots();
  }

  // Parar bot via backend
  async function stopBot(botId) {
    const res = await fetch(`${BACKEND_URL}/bots/${botId}/stop`, { method: 'POST' });
    if (res.ok) alert('Bot parado!');
    else alert('Erro ao parar bot');
    loadBots();
  }

  // Remover bot via backend
  async function removeBot(botId) {
    if (!confirm('Tem certeza que deseja remover o bot?')) return;
    const res = await fetch(`${BACKEND_URL}/bots/${botId}`, { method: 'DELETE' });
    if (res.ok) alert('Bot removido!');
    else alert('Erro ao remover bot');
    loadBots();
  }

  // Carregar e mostrar bots
  async function loadBots() {
    const botsList = document.getElementById('botsList');
    if (!botsList) return;

    botsList.innerHTML = '<p>Carregando bots...</p>';

    try {
      const botsData = await getBots(currentUser.id);
      if (!botsData.bots || botsData.bots.length === 0) {
        botsList.innerHTML = '<p>Nenhum bot hospedado.</p>';
        return;
      }

      botsList.innerHTML = '';
      botsData.bots.forEach(bot => {
        const botCard = document.createElement('div');
        botCard.className = 'bot-card';
        botCard.innerHTML = `
          <strong>${bot.name}</strong><br>
          Status: ${bot.status} | RAM: ${bot.ramUsage || 'N/A'}
          <div class="bot-actions">
            <button onclick="startBot('${bot.id}')">Iniciar</button>
            <button onclick="stopBot('${bot.id}')">Parar</button>
            <button onclick="removeBot('${bot.id}')">Remover</button>
          </div>
        `;
        botsList.appendChild(botCard);
      });
    } catch(e) {
      botsList.innerHTML = `<p>Erro ao carregar bots: ${e.message}</p>`;
    }
  }

  // CHAT SUPORTE - variáveis e funções simples

  let supportMessages = [];
  let currentUser = null;

  async function loadSupportMessages() {
    const chatDiv = document.getElementById('supportChat');
    if (!chatDiv) return;

    try {
      const res = await fetch(`${BACKEND_URL}/support/${currentUser.id}`);
      if (!res.ok) throw new Error('Erro ao carregar chat');
      const data = await res.json();
      supportMessages = data.messages || [];
      chatDiv.innerHTML = '';
      supportMessages.forEach(m => {
        const div = document.createElement('div');
        div.textContent = `${m.from}: ${m.message}`;
        chatDiv.appendChild(div);
      });
      chatDiv.scrollTop = chatDiv.scrollHeight;
    } catch(e) {
      chatDiv.innerHTML = `<p>Erro no chat: ${e.message}</p>`;
    }
  }

  async function sendSupportMessage() {
    const input = document.getElementById('supportInput');
    const msg = input.value.trim();
    if (!msg) return alert('Digite uma mensagem para enviar');
    try {
      const res = await fetch(`${BACKEND_URL}/support/${currentUser.id}`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ message: msg }),
      });
      if (!res.ok) throw new Error('Falha ao enviar mensagem');
      input.value = '';
      await loadSupportMessages();
    } catch(e) {
      alert(`Erro ao enviar mensagem: ${e.message}`);
    }
  }

  // Mostrar painel completo depois do login
  function showUserPanel(user) {
    currentUser = user;
    const content = document.getElementById('content');
    content.innerHTML = `
      <div style="display:flex; align-items:center; gap:15px; margin-bottom: 15px;">
        <img class="avatar" src="https://cdn.discordapp.com/avatars/${user.id}/${user.avatar}.png" alt="Avatar" onerror="this.onerror=null;this.src='https://cdn.discordapp.com/embed/avatars/0.png'" />
        <div>
          <h2>${user.username}#${user.discriminator}</h2>
          <p>ID: ${user.id}</p>
          <button id="btnLogout" class="btn">Logout</button>
        </div>
      </div>
      <h3>Seus Bots Hospedados</h3>
      <div id="botsList"></div>
      <h3>Chat de Suporte</h3>
      <div id="supportChat" style="background:#2c2f33; border-radius:6px; max-height:250px; overflow-y:auto; padding:10px; margin-bottom:10px;"></div>
      <div style="display:flex;">
        <input id="supportInput" type="text" placeholder="Digite sua mensagem..." />
        <button id="sendMsgBtn" class="btn">Enviar</button>
      </div>
    `;

    document.getElementById('btnLogout').addEventListener('click', () => {
      window.history.replaceState({}, document.title, REDIRECT_URI);
      window.location.reload();
    });

    document.getElementById('sendMsgBtn').addEventListener('click', sendSupportMessage);

    loadBots();
    loadSupportMessages();

    // Atualizar chat e bots a cada 15 segundos
    setInterval(loadSupportMessages, 15000);
    setInterval(loadBots, 15000);
  }

  async function main() {
    const params = new URLSearchParams(window.location.search);
    const code = params.get('code');

    if (!code) {
      redirectToDiscord();
      return;
    }

    const content = document.getElementById('content');
    content.innerHTML = '<p>Carregando dados do usuário...</p>';

    try {
      const user = await getUserInfo(code);
      showUserPanel(user);
      window.history.replaceState({}, document.title, REDIRECT_URI);
    } catch (err) {
      content.innerHTML = `<p>❌ Erro: ${err.message}</p>`;
    }
  }

  main();
</script>
</body>
</html>
